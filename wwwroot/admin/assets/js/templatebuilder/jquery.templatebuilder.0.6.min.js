!function(t){var e={},a=[],d={},r={},i="",l=!1,s="";window.Prototype&&(delete Object.prototype.toJSON,delete Array.prototype.toJSON,delete Hash.prototype.toJSON,delete String.prototype.toJSON),t.fn.templatebuilder=function(o){if(o){var n={};return n.form=e,n.datasets=d,"iscomplete"!=o||function(){var a=e.fields,d=!0;for(var r in console.log(a),a)a[r].name.length<1&&"textblock"!=a[r].fieldtype.fieldtype&&"section"!=a[r].fieldtype.fieldtype?(t("#"+r).addClass("tb-fieldIsEmpty"),d=!1):t("#"+r).removeClass("tb-fieldIsEmpty");return d}()?(t("#mura-formdata").val(JSON.stringify(n)),!0):!1}var u,c,m=t.extend({},t.fn.templatebuilder.defaults,m),f=t.parseJSON(t("#mura-formdata").val()),b={},h="",p="",v="",y="",g=t("#mura-tb-field"),x=t("#mura-tb-dataset-form"),C=t("#mura-tb-grid"),k="",w="";function O(t){null==b["field-block"]?Z("field-block",j,t):j("field-block",t)}function j(d,r){t("#mura-tb-fields-empty").hide();var i=t(b["field-block"]),l={};if(l.fieldType="field-"+r.fieldtype.fieldtype,l.fieldID=r.fieldid,t("ul",i).hide(),i.attr("id",r.fieldid),t(".mura-tb-block",i).attr("data-field",JSON.stringify(l)),t(".mura-tb-block",i).addClass(r.fieldtype.displaytype),i.addClass("field-"+r.fieldtype.fieldtype),t("span",i).html(r.label),t("#mura-tb-fields").append(i),a.length){var s=a.shift();O(e.fields[s])}}function D(){1==s&&(CKEDITOR.instances.field_textblock.destroy(),s=!1);t("#mura-tb-field-empty").hide(),g.hide(),x.hide(),C.hide(),""!=p&&(t(".ui-button",p).each(function(){t(this).unbind()}),t("ul",p).hide(),p.removeClass("selected"),t(".pointer").remove())}function E(){e.formattributes||(e.formattributes={});var a=e.formattributes;g.html(b["form-form"]),g.show(),t("#mura-tb-form").jsonForm({source:a,createOnNull:!0,createOnDataNull:!0,bindBy:"name",baseObject:"field"}),t("#mura-tb-form").bind("jsonformField",function(d,r){"selected"==r.kind?(null!=i&&t(i).removeClass("selected"),i=r.object,t(i).addClass("selected")):"update"==r.kind&&(a.isdirty=1,e.isdirty=1)}),t("#tb-name-restricted").change(function(){l=!!t("#tb-name-restricted").is(":checked")})}function N(){var a=e.fields[v],d="field-"+a.fieldtype.fieldtype;t(".tb-label").unbind(),t(".tb-name").unbind(),t("#mura-tb-field-form").unbind(),g.html(b[d]),g.show(),l?(t("#tb-name").removeClass("disabled"),t("#tb-name").removeAttr("disabled")):(t("#tb-name").addClass("disabled"),t("#tb-name").attr("disabled","true")),t("#mura-tb-form").jsonForm({source:a,createOnNull:!0,createOnDataNull:!0,bindBy:"name",baseObject:"field"}),t("#mura-tb-form").bind("jsonformField",function(d,r){"selected"==r.kind?(null!=i&&t(i).removeClass("selected"),i=r.object,t(i).addClass("selected")):"update"==r.kind&&(a.isdirty=1,e.isdirty=1)}),t("#mura-tb-form #mura-tb-form-label").html(t(".tb-label").val()),t(".tb-label").keyup(function(){var e=t(this).val(),a=e.replace(/[^a-zA-Z0-9_]/gi,"").toLowerCase();l||(a=a.replace(/^[^a-zA-Z]*/,""),t("#"+v).removeClass("tb-fieldIsEmpty"),t("#tb-name").val(a),t("#tb-name").trigger("change")),t("span",h).html(e),t("#mura-tb-form-label").html(e)}),t("#tb-name").keyup(function(){var e=t(this).val().replace(/[^a-zA-Z0-9_]/gi,"").toLowerCase();e=e.replace(/^[^a-zA-Z]*/,""),t("#"+v).removeClass("tb-fieldIsEmpty"),t("#tb-name").val(e),t("#tb-name").trigger("change")}),t("#ui-tabs").tabs(),"textblock"==a.fieldtype.fieldtype&&(t("#field_textblock").ckeditor({toolbar:"FormBuilder",customConfig:"config.js.cfm"},S),s=!0)}function S(){var a=CKEDITOR.instances.field_textblock,d=e.fields[v];a.on("change",function(e){d.value=t("#field_textblock").val()})}function A(){var t=e.fields[v].datasetid,a=d[t];y=a,x.hide(),C.hide(),""!=y.sourcetype?"entered"==y.sourcetype?null==b["dataset-grid"]?Z("dataset-grid",M):M():null==b["dataset-sourced"]?Z("dataset-sourced",I):I():J()}function I(){x.hide(),C.hide(),t(".ui-button",C).unbind(),C.html(b["dataset-sourced"]),t(".ui-button",C).click(function(){switch(t(this).attr("id")){case"button-grid-edit":J()}}),t("#tb-source").val(y.source),C.show()}function M(){var a=e.fields[v].datasetid;d[a];t(".ui-tabs-nav li",C).unbind(),C.html(b["dataset-grid"]),k=t("#mura-tb-grid-table"),w=t("#mura-tb-grid-table-header"),function(t){var a=e.fields[v].datasetid;d[a]}(),t(".ui-tabs-nav li",C).click(function(){switch(t(this).attr("id")){case"button-grid-edit":J()}}),t(".ui-button",C).click(function(){switch(t(this).attr("id")){case"button-grid-add":F()}}),t(document).on("click",".mura-tb-grid-radio",function(){id=t(this).attr("data-id"),y.defaultid=id}),t(document).on("click",C,function(){id=t(this).attr("data-id"),y.defaultid=id}),C.show(),null==b["dataset-row"]?Z("dataset-row",_):_()}function J(){var t=e.fields[v].datasetid,a=d[t];y=a,x.hide(),C.hide(),null==b["dataset-form"]?Z("dataset-form",K):T()}function T(){var a=e.fields[v].datasetid,r=d[a];switch(y=r,t(".mura-tb-dsi").hide(),y.sourcetype){case"entered":t(".mura-tb-grp-entered").show();break;case"dsp":case"object":case"remote":t(".mura-tb-grp-source").show();break;default:t(".mura-tb-grp-entered").show()}1==t("#mura-tb-dataset-issorted").val()?t(".mura-tb-grp-sorted").show():t(".mura-tb-grp-sorted").hide(),0==y.sourcetype.length?(t("#button-grid-grid",x).unbind(),t("#button-grid-grid",x).hide()):(t("#button-grid-grid",x).show(),t("#button-grid-grid",x).click(function(){A()})),t("#mura-tb-dataset-sourcetype").val(y.sourcetype),t("#mura-tb-dataset-issorted").val(y.issorted),t("#mura-tb-dataset-sorttype").val(y.sorttype),t("#mura-tb-dataset-sortcolumn").val(y.sortcolumn),t("#mura-tb-dataset-sortdirection").val(y.sortcolumn),t("#mura-tb-dataset-source").val(y.source),x.show()}function K(){var a=e.fields[v].datasetid,r=d[a];y=r,x.hide(),x.html(b["dataset-form"]),t("#mura-tb-dataset-sourcetype").change(function(){t(".mura-tb-dsi").hide(),y.sourcetype=t(this).val(),t("#button-grid-grid",x).unbind(),t("#button-grid-grid",x).hide(),"entered"==y.sourcetype?(t(".mura-tb-grp-entered").show(),1==t("#mura-tb-dataset-issorted").val()?t(".mura-tb-grp-sorted").show():t(".mura-tb-grp-sorted").hide()):t(".mura-tb-grp-source").show()}),t("#mura-tb-dataset-issorted").change(function(){t(".mura-tb-grp-sorted").hide(),y.issorted=t(this).val(),1==y.issorted?t(".mura-tb-grp-sorted").show():t(".mura-tb-grp-sorted").hide()}),t("#mura-tb-save-dataset").click(function(){y.sourcetype=t("#mura-tb-dataset-sourcetype").val(),y.issorted=t("#mura-tb-dataset-issorted").val(),y.sorttype=t("#mura-tb-dataset-sorttype").val(),y.sortcolumn=t("#mura-tb-dataset-sortcolumn").val(),y.sortdirection=t("#mura-tb-dataset-sortdirection").val(),y.source=t("#mura-tb-dataset-source").val(),"entered"==y.sourcetype||y.source.length?A():H("message-dataset-sourcerequired")}),T()}function _(){var a=e.fields[v].datasetid,r=d[a],i="";t(":input",k).unbind();k.html(""),w.html(""),1!=r.issorted&&k.sortable({axis:"y",opacity:.6,delay:200,update:function(e,a){var d=0;t(this).children().each(function(){++d%2?t(this).addClass("alt"):t(this).removeClass("alt")}),r.datarecordorder=k.sortable("toArray"),r.issortchanged=1},receive:function(t,e){}}),function(){var a=e.fields[v].datasetid,r=(d[a],t(b["dataset-row"])),i=t("#element-cell",r).html(),l=t("#element-row",r).html(),s="",o=t(l);(s=t(i)).addClass("mura-tb-cell-input"),s.addClass("mura-tb-cell-label"),s.html(t("#element-labels #label",r).html()),o.append(s);for(var n=0;n<m.dataColumns.length;n++)colName=m.dataColumns[n],(s=t(i)).addClass("mura-tb-cell-input"),s.html(t("#element-labels #"+colName,r).html()),o.append(s);w.append(o)}();for(var l=0;l<r.datarecordorder.length;l++)(i=r.datarecords[r.datarecordorder[l]])&&F(i)}function z(a){var r=e.fields[v].datasetid,i=d[r],l=a.id;t("#"+l,k).remove(),i.datarecords[l].config.isphantom||(i.deletedrecords[l]=1,i.isdirty=1),delete i.datarecords[l];for(var s=0;s<i.datarecordorder.length;s++)if(i.datarecordorder[s]==l){i.datarecordorder.splice(s,1);break}}function F(a){a||(a=function(){var a=e.fields[v].datasetid,r=d[a],i=uuid(),l=t.extend({},r.model);return r.iscomplete=0,r.isdirty=1,l.config={},l.datarecordid=i,l.config.isphantom=1,l.isdirty=1,r.datarecordorder.push(i),r.datarecords[i]=l,l}());var r=e.fields[v],i=r.datasetid,l=d[i],s="",o=t(b["dataset-row"]),n=t("#element-cell",o).html(),u=(t("#element-display",o).html(),t("#element-input",o).html()),c=t("#element-radio",o).html(),f=t("#element-checkbox",o).html(),h=t("#element-row",o).html(),p=t("#element-handle",o).html(),y=t("#element-button-delete",o).html(),g="",x="",C="",w="",O="",j=(C="","");(C=t(h)).attr("id",a.datarecordid),1!=l.issorted?(t("#mura-tb-grid-table-header li").removeClass("nohandle"),C.append(p)):t("#mura-tb-grid-table-header li").addClass("nohandle"),"checkbox"!=r.fieldtype.fieldtype?((g=t(n)).addClass("mura-tb-cell-small"),(w=t(c)).attr("data-id",a.datarecordid),w.attr("name","isdefault"),l.defaultid==a.datarecordid&&w.attr("CHECKED","CHECKED"),g.append(w),C.append(g)):((g=t(n)).addClass("mura-tb-cell-small"),(O=t(f)).attr("data-id",a.datarecordid),O.attr("name","isselected"),1==a.isselected&&O.attr("CHECKED","CHECKED"),g.append(O),C.append(g)),(g=t(n)).addClass("mura-tb-cell-input"),(x=t(u)).attr("data-id",a.datarecordid),x.attr("name","label"),x.val(a.label),g.append(x),C.append(g);for(var D=0;D<m.dataColumns.length;D++)s=m.dataColumns[D],(g=t(n)).addClass("mura-tb-cell-input"),(x=t(u)).attr("data-id",a.datarecordid),x.attr("name",s),x.val(a[s]),g.append(x),C.append(g);return(g=t(n)).addClass("mura-tb-cell-delete"),(j=t(y)).attr("data-id",a.datarecordid),g.append(j),C.append(g),k.append(C),k.children().length%2&&C.addClass("alt"),t(".mura-tb-grid-input",C).each(function(){t(this).keyup(function(){var e=t(this).attr("name"),a=t(this).attr("data-id");l.datarecords[a][e]=t(this).val(),l.datarecords[a].isdirty=1,l.isdirty=1})}),t(".button-grid-row-delete",C).click(function(){H("message-delete-row",!1,z,{id:t(this).attr("data-id")})}),t(".mura-tb-grid-checkbox",C).change(function(){var e=t(this).attr("name"),a=t(this).attr("data-id");l.datarecords[a][e]=t(this).is(":checked")?1:0,l.datarecords[a].isdirty=1,l.isdirty=1}),C}function H(e,a,d,r,i,l){bt={},0==a&&(bt[i||m.lbl.yes]=function(){t(this).dialog("close"),d&&d(r)}),bt[l||m.lbl.no]=function(){t(this).dialog("close")},b[e]?t("<div id='closable' style='display: none'>"+b[e]+"</div>").dialog({modal:!0,resizable:!1,buttons:bt}):function(e,a,d,r,i,l){var s={},o=Math.floor(9999999*Math.random());s.dialog=e,t.ajax({url:m.url+"?muraAction=cform.getdialog&i="+o,type:"POST",data:s,cache:!1,success:function(t){b[e]=t,H(e,a,d,r,i,l)},error:function(){alert("fail: load dialog")}})}(e,a,d,r,i,l)}function P(a){var d={},r=a,i=Math.floor(9999999*Math.random());d.fieldtype=r,d.formid=e.formid,t.ajax({url:m.url+"?muraAction=cform.getfield&i="+i,type:"POST",data:d,cache:!1,success:function(t){var a;a=t,e.fieldorder.push(a.fieldid),e.fields[a.fieldid]=a,O(a)},error:function(){alert("fail: load field")}})}function Z(a,d,r){var i={},l=Math.floor(9999999*Math.random());i.fieldType=a,i.formid=e.formid,t.ajax({url:m.url+"?muraAction=cform.getfieldtemplate&i="+l,type:"POST",data:i,cache:!1,success:function(t){b[a]=t,d?d(a,r):"form-form"==a?E():N()},error:function(){alert("fail: load template")}})}m.url||(m.url=t("#mura-templatebuilder").attr("data-url")),u=f,g.hide(),C.hide(),t("#mura-tb-fields").sortable({axis:"y",opacity:.6,delay:200,update:function(a,d){t(this).children().each(function(){}),e.fieldorder=t("#mura-tb-fields").sortable("toArray"),e.issortchanged=1}}),t("#mura-templatebuilder .mura-tb-form-menu div").click(function(){D(),null==b["form-form"]?Z("form-form"):E()}),t("#mura-templatebuilder .mura-tb-field-menu div").each(function(){var a=t(this);a.click(function(){P(t(this).attr("data-object"),e.formid)})}),t(document).on("click","#mura-tb-fields li div",function(){var a,r,i,l,s,o,n;a=t(this),r=a.parent(),i=a.attr("data-field"),l=t.parseJSON(i),s=e.fields[l.fieldID],o="field-"+s.fieldtype.fieldtype,n=t('<div class="pointer"></div>'),D(),h=a,p=r,v=l.fieldID,t("ul",p).show(),p.addClass("selected"),p.append(n),t(".mura-tb-nav-utility div",p).each(function(){t(this).click(function(){switch(t(this).attr("id")){case"button-trash":a=e.fields[v],r=t("#"+v),delete e.fields[v],t("#mura-tb-field-empty").show(),r.remove(),g.hide(),x.hide(),C.hide(),e.fieldorder=t("#mura-tb-fields").sortable("toArray"),a.datasetid&&a.datasetid.length&&delete d[a.datasetid],e.fieldorder.length||t("#mura-tb-fields-empty").show()}var a,r})}),null==b[o]?Z(o):N(),1==s.fieldtype.isdata&&(s.datasetid.length?A():function(a){var r={},i=e.fields[v],l=Math.floor(9999999*Math.random());r.datasetID=null==a?i.datasetid:a,r.fieldID=v,t.ajax({url:m.url+"?muraAction=cform.getdataset&i="+l,type:"POST",data:r,cache:!1,success:function(t){0==r.datasetID.length&&(d[t.datasetid]=t,i.datasetid=t.datasetid,J())},error:function(){alert("fail: load dataset")}})}())}),c=u,t("#mura-tb-fields").children().remove(),g.html(""),e=c.form,d=c.datasets,r.fields={},function(){if((a=e.fieldorder.slice(0)).length){var t=a.shift();O(e.fields[t])}}(),console.log(e.formattributes),e.formattributes&&1==e.formattributes["name-unrestricted"]&&(l=!0)},t.templatebuilder={},t.fn.templatebuilder.defaults={url:"",formid:"",mode:"create",dataColumns:["value"],lbl:{yes:"Yes",no:"Cancel",cancel:"Cancel"}},t.templatebuilder.clear=function(t){},uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})}}(jQuery);