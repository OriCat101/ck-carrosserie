!function(a){var e={};function i(){var i=a(".ui-minigrid-content",e);self.showModal(),self.identity=data.identity,self.sort=data.sortable,function(e){e&&(self.data=a.extend(!0,{},e));delete e,self.dataMap={};var i=self.data.rows,t=self.data.identity;for(var s in self.dataMap.id=self.data.id,self.dataMap.rowcount=0,self.dataMap.map={},self.dataMap.params={},self.dataMap.isdirty=0,self.dataMap.sorted=0,self.dataMap.global={},self.dataMap.records={},self.dataMap.orderlist=[],i){var d=i[s].data[t];self.dataMap.map[self.dataMap.rowcount]=d,self.dataMap.rowcount++;var l={isdirty:0,id:d,data:{}};(l=a.extend(!0,l,i[s])).row=s,self.dataMap.records[d]=l}}(data),a(".ui-minigrid-header-list",e).children().remove(),a(".ui-minigrid-content",e).children().remove(),e.unbind(),a(":checkbox,:radio",i).unbind(),a(":text",i).unbind(),a(".ui-icon-close",i).unbind(),a(".ui-minigrid-body",e).resizable("destroy"),a(".ui-minigrid-body",e).attr("style",""),1==self.sort&&i.sortable({axis:"y",opacity:.6,delay:200,update:function(a,e){self.dataMap.isdirty=1,self.dataMap.sorted=1,d()}}),data.columns.length&&function(){var i=a(".ui-minigrid-header-list",e),t=[],s=[],d="",r=self.data.columns;self.data.rows;s.push("<ul class='column'>"),"create"==l.mode&&s.push("<li class='button'></li>");for(var n=0;n<r.length;n++){switch(t=[],r[n].render){case"radio":case"checkbox":t.push("<li class='bit'>");break;default:"label"==r[n].name?t.push("<li style='width: "+l.widthPrimary+"px'>"):t.push("<li style='width: "+l.widthSecondary+"px'>")}t.push("<span>"+r[n].label+"</span></li>"),s.push(t.join(""))}self.sort&&s.push("<li class='sort'><span class='ui-icon "+l.sortIcon+"' title='"+l.sortIconTitle+"'></span></li>");s.push("</ul>"),d=s.join(""),i.append(a(d)),e.width(1500),e.width(a(".column",i).width()+19),a(".ui-minigrid-body",e).height(l.height),l.resizable?a(".ui-resize",e).resizable({handles:"s",alsoResize:".ui-minigrid-body",resize:function(i,t){a(".ui-resize",e).attr("style","")}}):a(".ui-minigrid-body",e).addClass("ui-minigrid-bordered")}(),data.rows.length&&function(){var i=a(".ui-minigrid-content",e),s="",d=(self.data.columns,self.dataMap.records);for(var l in d)1!=d[l].del&&(s=t(d[l]),i.append(s));self.data.rows=[],a("li.row:even",i).addClass("even")}(),l.onRenderComplete(),self.hideModal()}function t(e){var i=self.data.columns,t=self.data.identity,s=e.data,d=a("<ul class='column'></ul>");if("create"==l.mode){var r=a("<li class='bit'><span class='sb-button ui-state-default'><a href='#' class='ui-icon ui-icon-close'></a></span></li>");d.append(r)}for(var n=0;n<i.length;n++){aCol=[];i[n].name;switch(i[n].render){case"radio":aCol.push("<li class='bit'><input class='radio' id='"),aCol.push(e.row+"_"+i[n].name),aCol.push("' value='"),aCol.push(s[t]),""!=s[i[n].name]&&0!=s[i[n].name]&&aCol.push("' checked='checked"),aCol.push("' type='radio'></li>"),$col=a(aCol.join(""));break;case"checkbox":aCol.push("<li class='bit'><input class='checkbox' id='"),aCol.push(e.row+"_"+i[n].name),""!=s[i[n].name]&&0!=s[i[n].name]&&aCol.push("' checked='checked"),aCol.push("' value='1' type='checkbox'></li>"),$col=a(aCol.join(""));break;default:1==i[n].editable?("label"==i[n].name?aCol.push("<li class='col' style='width: "+l.widthPrimary+"px'><input class='text' style='width: "+(l.widthPrimary-4)+"px' id='"):aCol.push("<li class='col' style='width: "+l.widthSecondary+"px'><input class='text' style='width: "+(l.widthSecondary-4)+"px' id='"),aCol.push(e.row+"_"+i[n].name),aCol.push("' value='"),aCol.push(s[i[n].name]),aCol.push("' type='input'></li>"),$col=a(aCol.join(""))):"label"==i[n].name?$col=a("<li class='col' style='width: "+l.widthPrimary+"px'>"+s[i[n].name]+"</li>"):$col=a("<li class='col' style='width: "+l.widthSecondary+"px'>"+s[i[n].name]+"</li>")}d.append($col)}return self.sort&&d.append(a("<li class='sort'><span class='ui-icon ui-icon-grip-dotted-vertical'></span></li>")),$fullrow=a("<li class='row clearfix'></li>").append(d),$fullrow.attr("id",e.row),$fullrow}function s(){var i={},s=self.data.record,l=self.dataMap.rowcount;for(var r in s)i[s[r].name]=s[r].value;i[self.data.identity]=l,self.dataMap.map[l]=l;var n={isdirty:1,del:!1,row:self.dataMap.rowcount,isphantom:1,id:l,data:i};self.dataMap.records[l]=n,self.dataMap.isdirty=1,function(e,i,s){var l=a(".ui-minigrid-content",e);$row=t(i),l.append($row),a(":text:first",$row).focus(),d()}(e,self.dataMap.records[l]),self.dataMap.rowcount++}function d(){var i=a(".ui-minigrid-content",e);a("li.row",i).removeClass("even"),a("li.row:even",i).addClass("even")}a.fn.minigrid=function(i){if(e=a(this),r[i])return alert("method"),r[i].apply(this,Array.prototype.slice.call(arguments,1));if("object"==typeof i||!i){var t=r.init.apply(this,arguments);return alert("init: "+e),e.data("_isInitialized",!0),{},self.isLoading=!1,self.identity="",self.sort=!1,self.input=a("<input type='hidden' name='"+l.fieldname+"' id='minigrid-"+l.id+"' value=''>"),self.showModal=function(){a(".ui-minigrid-modal",e).show()},self.hideModal=function(){a(".ui-minigrid-modal",e).hide()},self.hideModal(),function(){self.showModal(),alert(self.sort),e.width(l.width);var i,t=a("<div class='ui-minigrid'></div>"),r=a("<div class='ui-minigrid-modal'><div class='ui-minigrid-spinner'></div></div>"),n=a("<div class='ui-minigrid-header ui-widget-header ui-state-default ui-minigrid-boxed clearfix'></div>"),o=a("<ul class='ui-minigrid-header-list clearfix'></ul>"),c=a("<div class='ui-minigrid-body ui-minigrid-boxed clearfix'></div>"),u=a("<ul class='ui-minigrid-content'></ul>"),p=a("<div class='ui-resize'></div>"),f=a("<ul class='table-buttons three left'></ul>"),h=a("<ul class='table-buttons one right'></ul>"),m=a("<li class='bit'><span class='sb-button ui-state-default'><a id='minigrid-add' href='#' class='ui-icon ui-icon-document-b'></a></span></li>"),g=a("<li class='bit'><span class='sb-button ui-state-default'><a id='minigrid-save' href='#' class='ui-icon ui-icon-disk'></a></span></li>"),v=a("<li class='bit'><span class='sb-button ui-state-default'><a id='minigrid-refresh' href='#' class='ui-icon ui-icon-refresh'></a></span></li>"),y=a("<li class='bit'><span class='sb-button ui-state-default'><a id='minigrid-openclose' href='#' class='ui-icon ui-icon-minus'></a></span></li>");t.data("state",1),f.append(self.input),f.append(m),f.append(v),h.append(y),n.append(o),c.append(u),t.append(n),t.append(c),e.append(t),e.addClass("ui-minigrid"),e.append(r),e.append(p),m.click(function(){s(),0==t.data("state")&&(t.show(),t.data("state",1))}),g.click(function(){remoteSaveData()}),v.click(function(){alert(myDump(self.getDataMap(),"","  ",0,30))}),y.click(function(){a("#minigrid-openclose").toggleClass("ui-icon-minus").toggleClass("ui-icon-plus"),1==t.data("state")?(t.hide(),t.data("state",0)):(t.show(),t.data("state",1))}),self.isLoading=!1,i=a(".ui-minigrid-content",e),e.keydown(function(e){if("38"==e.keyCode&&"text"==a(e.target).attr("type")){var i=a(e.target).parents("ul:first").parent(),t=i.index();if(0==t)return;var d=a(e.target).attr("name"),l=a("[name="+d+"]",i.parent().children()[t-1]);a(e.target).change(),l.focus()}else if("40"==e.keyCode&&"text"==a(e.target).attr("type")){var i=a(e.target).parents("ul:first").parent(),t=i.index();if(t+1>=i.parent().children().length)return;var d=a(e.target).attr("name"),l=a("[name="+d+"]",i.parent().children()[t+1]);a(e.target).change(),l.focus()}else if("9"==e.keyCode&&0==e.shiftKey){var r=a(e.target).parents("ul:first"),i=r.parent(),n=r.children(),t=i.index();if(self.sort)var o=2;else var o=1;t+1==i.parent().children().length&&a(e.target).parent().index()+o==n.length&&(a(e.target).change(),s(),e.preventDefault())}}),a(":checkbox,:radio",i).on("change",function(e){var i=a(e.target),t=i.attr("id").split("_"),s=t[0],d=t[1],l=i.attr("value"),r=i.attr("type"),n=self.dataMap.map[s];switch(r){case"checkbox":self.dataMap.records[n].data[d]=i.is(":checked")?l:0,self.dataMap.records[n].isdirty=1;break;case"radio":self.dataMap.records[n].data[d]=i.is(":checked")?1:0,self.dataMap.global[d]=l,self.dataMap.records[n].isdirty=1}self.dataMap.isdirty=1}),a(":text",i).on("keyup",function(e){var i=a(e.target),t=i.attr("id").split("_"),s=t[0],d=t[1],l=i.attr("value"),r=(i.attr("type"),self.dataMap.map[s]);i.attr("value")!=self.dataMap.records[r].data[d]&&self.dataMap.records[r]&&(self.dataMap.records[r].data[d]=l,self.dataMap.records[r].isdirty=1,self.dataMap.isdirty=1)}),a(".ui-icon-close",i).on("click",function(e){var i=a(e.target),t=i.parents("ul:first").parent(),s=t.attr("id"),r=self.dataMap.map[s];self.dataMap.records[r]&&(self.dataMap.records[r].isphantom?(delete self.dataMap.records[r],delete self.dataMap.map[s],l.commitOnSave||(self.dataMap.isdirty=1)):(self.dataMap.records[r].isdirty=1,self.dataMap.records[r].del=!0,self.dataMap.isdirty=1),t.remove(),d())})}(),t}a.error("Method "+i+" does not exist on jQuery.tooltip")},doSerialize=function(){if(self.sort){var i=a(".ui-minigrid-content",e).sortable("toArray");self.dataMap.orderlist=[];for(var t=0;t<i.length;t++){var s=self.dataMap.map[i[t]];self.dataMap.records[s].row=t,self.dataMap.orderlist.push(s)}return i}},self.getDataMap=function(){return doSerialize(),self.dataMap},self.getIsisdirty=function(){return self.dataMap.isdirty},self.getDataList=function(){doSerialize();var a=[],e=self.dataMap.map;for(var i in e){var t=self.dataMap.records[e[i]],s={};s[self.data.identity]=t.id,s.label=t.data.label,a.push(s)}return a},a.fn.minigrid.defaults={width:253,height:200,url:"",data:{},source:{},loadMethod:{},saveMethod:{},id:"",contentid:"",onRenderComplete:function(){},loadOptions:{method:"getDataProvider",returnFormat:"json"},saveOptions:{method:"saveDataProvider",returnFormat:"json"},afterSave:function(){},sortIcon:"ui-icon-arrowthick-2-n-s",sortIconTitle:"sortable",autoloadTemplate:!0,commitOnSave:!0,resizable:!1,widthPrimary:130,widthSecondary:90,dataToFormField:!1,fieldname:"",mode:"create"};var l=a.fn.minigrid.defaults,r={init:function(e){l=a.extend({},a.fn.minigrid.defaults,e)},set:function(a){i()}}}(jQuery);