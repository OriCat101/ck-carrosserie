!function(t){var e={ismuraorm:0},a=0,r=[],d={},i={},l="",s=!1,o=!1,n="";window.Prototype&&(delete Object.prototype.toJSON,delete Array.prototype.toJSON,delete Hash.prototype.toJSON,delete String.prototype.toJSON),t.fn.templatebuilder=function(u){if(u){var c={};return c.form=e,c.datasets=d,"iscomplete"!=u||function(){var a=e.fields,r=!0;for(var d in a)a[d].name.length<1&&"textblock"!=a[d].fieldtype.fieldtype&&"section"!=a[d].fieldtype.fieldtype?(t("#"+d).addClass("tb-fieldIsEmpty"),r=!1):t("#"+d).removeClass("tb-fieldIsEmpty");return r}()?(t("#mura-formdata").val(JSON.stringify(c)),!0):!1}var m=t.extend({},t.fn.templatebuilder.defaults,m),f=t.parseJSON(t("#mura-formdata").val()),b={},p="",h="",g="",v="",y=t("#mura-tb-field"),C=t("#mura-tb-dataset-form"),x=t("#mura-tb-grid"),k="",w="";function O(){return e.pages[a]}function j(t){e.pages[a]=t}function D(t){null==b["field-block"]?Q("field-block",E,t):E("field-block",t)}function E(a,d){t("#mura-tb-fields-empty").hide();var i=t(b["field-block"]),l={};if(l.fieldType="field-"+d.fieldtype.fieldtype,l.fieldID=d.fieldid,t("ul",i).hide(),i.attr("id",d.fieldid),t(".mura-tb-block",i).attr("data-field",JSON.stringify(l)),t(".mura-tb-block",i).addClass(d.fieldtype.displaytype),i.addClass("field-"+d.fieldtype.fieldtype),t("span",i).html(d.label),t("#mura-tb-fields").append(i),r.length){var s=r.shift();D(e.fields[s])}}function N(e,r){$("#mura-form-pages li").removeClass("current");var d='<li id="page-~page~" data-page="~page~"></li>';d=$(d.replace(/\~page\~/g,e));e==a&&d.addClass("current"),d.html(e),t("#mura-form-pages").append(d),d.click(function(){S($(this).attr("data-page"))}),r&&S(e)}function S(d){$("#mura-form-pages li").removeClass("current"),$("#mura-form-pages .button-trash").remove(),R(),a=d-1;var i=t("#page-"+d),l=t('<div class="button-trash" title="Delete"></div>');i.addClass("current"),d>1&&(i.append(l),$(".button-trash",i).click(function(){var t=$(this).parent(),a=t.attr("data-page");t.remove();var r=e.pages.splice(a-1,1);if(r&&r[0].length)for(var d=0;d<r[0].length;d++)e.pages[a-2].push(r[0][d]);S(a-1)})),function(){if(t("#mura-tb-fields").empty(),(r=e.pages[a].slice(0)).length){var d=r.shift();D(e.fields[d])}}()}function A(){1==n&&(CKEDITOR.instances.field_textblock.destroy(),n=!1);t("#mura-tb-field-empty").hide(),y.hide(),C.hide(),x.hide(),""!=h&&(t(".ui-button",h).each(function(){t(this).unbind()}),t("ul",h).hide(),h.removeClass("selected"),t(".pointer").remove())}function I(){e.formattributes||(e.formattributes={});var a=e.formattributes;y.html(b["form-form"]),y.show(),t("#mura-tb-form").jsonForm({source:a,createOnNull:!1,createOnDataNull:!1,bindBy:"name",baseObject:"field"}),t("#mura-tb-form").bind("jsonformField",function(r,d){"selected"==d.kind?(null!=l&&t(l).removeClass("selected"),l=d.object,t(l).addClass("selected")):"update"==d.kind&&(a.isdirty=1,e.isdirty=1),void 0!==d.item&&(void 0!==d.value?a[d.item]=d.value:delete a[d.item])}),t("#tb-name-restricted").change(function(){s=!!t("#tb-name-restricted").is(":checked")}),t("#tb-muraormentities").change(function(){t("#tb-muraormentities").is(":checked")?(o=!0,t("#button-file").hide(),t("#button-nested").hide()):(o=!1,t("#button-file").show(),t("#button-nested").show())})}function M(){var a=e.fields[g],r="field-"+a.fieldtype.fieldtype;t(".tb-label").unbind(),t(".tb-name").unbind(),t("#mura-tb-field-form").unbind(),y.html(b[r]),y.show(),s?(t("#tb-name").removeClass("disabled"),t("#tb-name").removeAttr("disabled")):(t("#tb-name").addClass("disabled"),t("#tb-name").attr("disabled","true")),t("#mura-tb-form").jsonForm({source:a,createOnNull:!0,createOnDataNull:!1,bindBy:"name",baseObject:"field"}),t("#mura-tb-form").bind("jsonformField",function(r,d){"selected"==d.kind?(null!=l&&t(l).removeClass("selected"),l=d.object,t(l).addClass("selected")):"update"==d.kind&&(a.isdirty=1,e.isdirty=1)}),t("#mura-tb-form #mura-tb-form-label").html(t(".tb-label").val()),t(".tb-label").keyup(function(){var e=t(this).val(),a=e.replace(/[^a-zA-Z0-9_]/gi,"").toLowerCase();s||(a=a.replace(/^[^a-zA-Z]*/,""),t("#"+g).removeClass("tb-fieldIsEmpty"),t("#tb-name").val(a),t("#tb-name").trigger("change")),t("span",p).html(e),t("#mura-tb-form-label").html(e)}),t("#tb-name").keyup(function(){var e=t(this).val().replace(/[^a-zA-Z0-9_]/gi,"").toLowerCase();e=e.replace(/^[^a-zA-Z]*/,""),t("#"+g).removeClass("tb-fieldIsEmpty"),t("#tb-name").val(e),t("#tb-name").trigger("change")}),t("#ui-tabs").tabs(),"textblock"==a.fieldtype.fieldtype&&(t("#field_textblock").ckeditor({toolbar:"FormBuilder",customConfig:"config.js.cfm"},T),n=!0)}function T(){var a=CKEDITOR.instances.field_textblock,r=e.fields[g];a.on("change",function(e){r.value=t("#field_textblock").val()})}function J(){var t=e.fields[g].datasetid,a=d[t];v=a,C.hide(),x.hide(),""!=v.sourcetype?"entered"==v.sourcetype?null==b["dataset-grid"]?Q("dataset-grid",_):_():null==b["dataset-sourced"]?Q("dataset-sourced",K):K():z()}function K(){C.hide(),x.hide(),t(".ui-button",x).unbind(),x.html(b["dataset-sourced"]),t(".ui-button",x).click(function(){switch(t(this).attr("id")){case"button-grid-edit":z()}}),t("#tb-source").val(v.source),x.show()}function _(){var a=e.fields[g].datasetid;d[a];t(".ui-tabs-nav li",x).unbind(),x.html(b["dataset-grid"]),k=t("#mura-tb-grid-table"),w=t("#mura-tb-grid-table-header"),function(t){var a=e.fields[g].datasetid;d[a]}(),t(".ui-tabs-nav li",x).click(function(){switch(t(this).attr("id")){case"button-grid-edit":z()}}),t(".ui-button",x).click(function(){switch(t(this).attr("id")){case"button-grid-add":B()}}),t(document).on("click",".mura-tb-grid-radio",function(){id=t(this).attr("data-id"),id&&(v.defaultid=id)}),t(document).on("click",x,function(){id=t(this).attr("data-id"),id&&(v.defaultid=id)}),x.show(),null==b["dataset-row"]?Q("dataset-row",P):P()}function z(){var t=e.fields[g].datasetid,a=d[t];v=a,C.hide(),x.hide(),null==b["dataset-form"]?Q("dataset-form",H):F()}function F(){var a=e.fields[g],r=a.datasetid,i=d[r];switch(v=i,t(".mura-tb-dsi").hide(),o?t("#dataset-source-muraorm").show():t("#dataset-source-muraorm").hide(),"multientity"!=a.fieldtype.fieldtype&&t("#mura-tb-grp-sourcetype").hide(),v.sourcetype){case"multientity":t(".mura-tb-grp-entered").hide();case"entered":t(".mura-tb-grp-entered").show();break;case"multientity":t(".mura-tb-grp-source").show(),t(".mura-tb-grp-sourcetype").hide(),t("#button-grid-grid").hide();break;case"dsp":case"object":case"muraorm":case"remote":t(".mura-tb-grp-source").show();break;default:t(".mura-tb-grp-entered").show(),0==v.sourcetype.length?(t("#button-grid-grid",C).unbind(),t("#button-grid-grid",C).hide()):(t("#button-grid-grid",C).show(),t("#button-grid-grid",C).click(function(){J()}))}1==t("#mura-tb-dataset-issorted").val()?t(".mura-tb-grp-sorted").show():t(".mura-tb-grp-sorted").hide(),t("#mura-tb-dataset-sourcetype").val(v.sourcetype),t("#mura-tb-dataset-issorted").val(v.issorted),t("#mura-tb-dataset-sorttype").val(v.sorttype),t("#mura-tb-dataset-sortcolumn").val(v.sortcolumn),t("#mura-tb-dataset-sortdirection").val(v.sortcolumn),t("#mura-tb-dataset-source").val(v.source),C.show()}function H(){var a=e.fields[g],r=a.datasetid,i=d[r];v=i,C.hide(),C.html(b["dataset-form"]),t("#mura-tb-dataset-sourcetype").change(function(){t(".mura-tb-dsi").hide(),v.sourcetype=t(this).val(),t("#button-grid-grid",C).unbind(),t("#button-grid-grid",C).hide(),"entered"==v.sourcetype?(t(".mura-tb-grp-entered").show(),1==t("#mura-tb-dataset-issorted").val()?t(".mura-tb-grp-sorted").show():t(".mura-tb-grp-sorted").hide()):"muraorm"==v.sourcetype?(t(".mura-tb-grp-entered").hide(),t(".mura-tb-grp-source").show(),t("#button-grid-grid",C).hide()):t(".mura-tb-grp-source").show()}),t("#mura-tb-dataset-issorted").change(function(){t(".mura-tb-grp-sorted").hide(),v.issorted=t(this).val(),1==v.issorted?t(".mura-tb-grp-sorted").show():t(".mura-tb-grp-sorted").hide()}),"multientity"==a.fieldtype.fieldtype&&(t("#mura-tb-grp-sourcetype").hide(),t(".mura-tb-grp-entered").hide(),t(".mura-tb-grp-source").hide(),v.sourcetype="muraorm"),t("#mura-tb-save-dataset").click(function(){v.sourcetype=t("#mura-tb-dataset-sourcetype").val(),v.issorted=t("#mura-tb-dataset-issorted").val(),v.sorttype=t("#mura-tb-dataset-sorttype").val(),v.sortcolumn=t("#mura-tb-dataset-sortcolumn").val(),v.sortdirection=t("#mura-tb-dataset-sortdirection").val(),v.source=t("#mura-tb-dataset-source").val(),"entered"==v.sourcetype||"muraorm"==v.sourcetype||"multientity"==v.sourcetype||v.source.length?J():L("message-dataset-sourcerequired")}),F()}function P(){var a=e.fields[g].datasetid,r=d[a],i="";t(":input",k).unbind();k.html(""),w.html(""),1!=r.issorted&&k.sortable({axis:"y",opacity:.6,delay:200,update:function(e,a){var d=0;t(this).children().each(function(){++d%2?t(this).addClass("alt"):t(this).removeClass("alt")}),r.datarecordorder=k.sortable("toArray"),r.issortchanged=1},receive:function(t,e){}}),function(){var a=e.fields[g].datasetid,r=(d[a],t(b["dataset-row"])),i=t("#element-cell",r).html(),l=t("#element-row",r).html(),s="",o=t(l);(s=t(i)).addClass("mura-tb-cell-input"),s.addClass("mura-tb-cell-label"),s.html(t("#element-labels #label",r).html()),o.append(s);for(var n=0;n<m.dataColumns.length;n++)colName=m.dataColumns[n],(s=t(i)).addClass("mura-tb-cell-input"),s.html(t("#element-labels #"+colName,r).html()),o.append(s);w.append(o)}();for(var l=0;l<r.datarecordorder.length;l++)(i=r.datarecords[r.datarecordorder[l]])&&B(i)}function Z(a){var r=e.fields[g].datasetid,i=d[r],l=a.id;t("#"+l,k).remove(),i.datarecords[l].config.isphantom||(i.deletedrecords[l]=1,i.isdirty=1),delete i.datarecords[l];for(var s=0;s<i.datarecordorder.length;s++)if(i.datarecordorder[s]==l){i.datarecordorder.splice(s,1);break}}function B(a){a||(a=function(){var a=e.fields[g].datasetid,r=d[a],i=uuid(),l=t.extend({},r.model);return r.iscomplete=0,r.isdirty=1,l.config={},l.datarecordid=i,l.config.isphantom=1,l.isdirty=1,r.datarecordorder.push(i),r.datarecords[i]=l,l}());var r=e.fields[g],i=r.datasetid,l=d[i],s="",o=t(b["dataset-row"]),n=t("#element-cell",o).html(),u=(t("#element-display",o).html(),t("#element-input",o).html()),c=t("#element-radio",o).html(),f=t("#element-checkbox",o).html(),p=t("#element-row",o).html(),h=t("#element-handle",o).html(),v=t("#element-button-delete",o).html(),y="",C="",x="",w="",O="",j=(x="","");(x=t(p)).attr("id",a.datarecordid),1!=l.issorted?(t("#mura-tb-grid-table-header li").removeClass("nohandle"),x.append(h)):t("#mura-tb-grid-table-header li").addClass("nohandle"),"checkbox"!=r.fieldtype.fieldtype?((y=t(n)).addClass("mura-tb-cell-small"),(w=t(c)).attr("data-id",a.datarecordid),w.attr("name","isdefault"),l.defaultid==a.datarecordid&&w.attr("CHECKED","CHECKED"),y.append(w),x.append(y)):((y=t(n)).addClass("mura-tb-cell-small"),(O=t(f)).attr("data-id",a.datarecordid),O.attr("name","isselected"),1==a.isselected&&O.attr("CHECKED","CHECKED"),y.append(O),x.append(y)),(y=t(n)).addClass("mura-tb-cell-input"),(C=t(u)).attr("data-id",a.datarecordid),C.attr("name","label"),C.val(a.label),y.append(C),x.append(y);for(var D=0;D<m.dataColumns.length;D++)s=m.dataColumns[D],(y=t(n)).addClass("mura-tb-cell-input"),(C=t(u)).attr("data-id",a.datarecordid),C.attr("name",s),C.val(a[s]),y.append(C),x.append(y);return(y=t(n)).addClass("mura-tb-cell-delete"),(j=t(v)).attr("data-id",a.datarecordid),y.append(j),x.append(y),k.append(x),k.children().length%2&&x.addClass("alt"),t(".mura-tb-grid-input",x).each(function(){t(this).keyup(function(){var e=t(this).attr("name"),a=t(this).attr("data-id");l.datarecords[a][e]=t(this).val(),l.datarecords[a].isdirty=1,l.isdirty=1})}),t(".button-grid-row-delete",x).click(function(){L("message-delete-row",!1,Z,{id:t(this).attr("data-id")})}),t(".mura-tb-grid-checkbox",x).change(function(){var e=t(this).attr("name"),a=t(this).attr("data-id");l.datarecords[a][e]=t(this).is(":checked")?1:0,l.datarecords[a].isdirty=1,l.isdirty=1}),x}function L(e,a,r,d,i,l){bt={},0==a&&(bt[i||m.lbl.yes]=function(){t(this).dialog("close"),r&&r(d)}),bt[l||m.lbl.no]=function(){t(this).dialog("close")},b[e]?t("<div id='closable' style='display: none'>"+b[e]+"</div>").dialog({modal:!0,resizable:!1,buttons:bt}):function(e,a,r,d,i,l){var s={},o=Math.floor(9999999*Math.random());s.dialog=e,t.ajax({url:m.url+"?muraAction=cform.getdialog&i="+o,type:"POST",data:s,cache:!1,success:function(t){b[e]=t,L(e,a,r,d,i,l)},error:function(){alert("fail: load dialog")}})}(e,a,r,d,i,l)}function R(){t("#mura-tb-fields").children().remove(),y.html("")}function q(a){var r={},d=a,i=Math.floor(9999999*Math.random());r.fieldtype=d,r.formid=e.formid,t.ajax({url:m.url+"?muraAction=cform.getfield&i="+i,type:"POST",data:r,cache:!1,success:function(t){var a;a=t,O().push(a.fieldid),e.fields[a.fieldid]=a,D(a)},error:function(){alert("fail: load field")}})}function Q(a,r,d){var i={},l=Math.floor(9999999*Math.random());i.fieldType=a,i.formid=e.formid,t.ajax({url:m.url+"?muraAction=cform.getfieldtemplate&i="+l,type:"POST",data:i,cache:!1,success:function(t){b[a]=t,r?r(a,d):"form-form"==a?I():M()},error:function(){alert("fail: load template")}})}function Y(a){var r={},i=e.fields[g],l=Math.floor(9999999*Math.random());r.datasetID=null==a?i.datasetid:a,r.fieldID=g,t.ajax({url:m.url+"?muraAction=cform.getdataset&i="+l,type:"POST",data:r,cache:!1,success:function(t){0==r.datasetID.length&&(d[t.datasetid]=t,i.datasetid=t.datasetid,z())},error:function(){alert("fail: load dataset")}})}m.url||(m.url=t("#mura-templatebuilder").attr("data-url")),function(r){y.hide(),x.hide(),a=0,t("#mura-tb-fields").sortable({axis:"y",opacity:.6,delay:200,update:function(a,r){t(this).children().each(function(){}),j(t("#mura-tb-fields").sortable("toArray")),e.issortchanged=1}}),t("#mura-templatebuilder .mura-tb-form-menu div").click(function(){A(),null==b["form-form"]?Q("form-form"):I()}),t("#mura-templatebuilder .mura-tb-field-menu div").each(function(){var a=t(this);a.click(function(){q(t(this).attr("data-object"),e.formid)})}),t(document).on("click","#mura-tb-fields li div",function(){var a,r,i,l,s,o,n;a=t(this),r=a.parent(),i=a.attr("data-field"),l=t.parseJSON(i),s=e.fields[l.fieldID],o="field-"+s.fieldtype.fieldtype,n=t('<div class="pointer"></div>'),A(),p=a,h=r,g=l.fieldID,t("ul",h).show(),h.addClass("selected"),h.append(n),t(".mura-tb-nav-utility div",h).each(function(){t(this).click(function(){switch(t(this).attr("id")){case"button-trash":a=e.fields[g],r=t("#"+g),delete e.fields[g],t("#mura-tb-field-empty").show(),r.remove(),y.hide(),C.hide(),x.hide(),j(t("#mura-tb-fields").sortable("toArray")),a.datasetid&&a.datasetid.length&&delete d[a.datasetid],O().length||t("#mura-tb-fields-empty").show()}var a,r})}),null==b[o]?(Q(o),setTimeout(function(){1==s.fieldtype.isdata&&(s.datasetid.length?J():Y())},100)):(M(),1==s.fieldtype.isdata&&(s.datasetid.length?J():Y()))}),t("#mura-form-addpage").click(function(){e.pages.push([]),N(e.pages.length,!0)}),l=r,R(),e=l.form,a=0,e.pages||(e.pages=[]),e.pages.length||e.pages.push([]),e.fieldorder.length>0&&(e.pages[0]=e.fieldorder,e.fieldorder=[]),d=l.datasets,i.fields={},function(r){a=r,t("#mura-form-pages").empty();for(var d=0;d<e.pages.length;d++)N(d+1)}(a),S(1),e.formattributes&&1==e.formattributes["name-unrestricted"]&&(s=!0);var l;e.formattributes&&1==e.formattributes.muraormentities?(o=!0,t("#button-nested").hide(),t("#button-file").hide()):(o=!1,t("#button-file").show(),t("#button-nested").show())}(f)},t.templatebuilder={},t.fn.templatebuilder.defaults={url:"",formid:"",mode:"create",dataColumns:["value"],lbl:{yes:"Yes",no:"Cancel",cancel:"Cancel"}},t.templatebuilder.clear=function(t){},uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})}}(jQuery);